//@version=5
strategy("EMA Trend + RSI Strategy", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// ============================================================================
// PROFITABLE BEGINNER STRATEGY
// EMA Trend Following + RSI Confirmation
// Timeframe: 15m or 1h (avoid noise)
// Pair: BTCUSDT (high liquidity)
// ============================================================================

// INPUT PARAMETERS
ema_fast = input.int(9, "Fast EMA", minval=1)
ema_slow = input.int(21, "Slow EMA", minval=1)
ema_trend = input.int(200, "Trend EMA", minval=1)
rsi_length = input.int(14, "RSI Length", minval=1)
rsi_oversold = input.int(30, "RSI Oversold", minval=1, maxval=50)
rsi_overbought = input.int(70, "RSI Overbought", minval=50, maxval=100)

// RISK MANAGEMENT
stop_loss_pct = input.float(2.0, "Stop Loss %", minval=0.5, maxval=10.0)
take_profit_pct = input.float(4.0, "Take Profit %", minval=1.0, maxval=20.0)

// WEBHOOK SETTINGS
webhook_url = input.string("", "Webhook URL", tooltip="Your bot webhook URL")

// ============================================================================
// CALCULATE INDICATORS
// ============================================================================

// EMAs
ema9 = ta.ema(close, ema_fast)
ema21 = ta.ema(close, ema_slow)
ema200 = ta.ema(close, ema_trend)

// RSI
rsi = ta.rsi(close, rsi_length)

// Volume (avoid low volume periods)
vol_avg = ta.sma(volume, 20)
high_volume = volume > vol_avg * 1.2

// ============================================================================
// TREND DETECTION (CRITICAL FOR PROFITABILITY)
// ============================================================================

// Main trend (only trade WITH the trend)
uptrend = close > ema200 and ema9 > ema21
downtrend = close < ema200 and ema9 < ema21
sideways = not uptrend and not downtrend

// ============================================================================
// ENTRY CONDITIONS (STRICT RULES)
// ============================================================================

// BUY CONDITIONS (ALL must be true)
buy_condition = uptrend and                    // 1. Uptrend confirmed
                ta.crossover(ema9, ema21) and  // 2. EMA crossover
                rsi < 60 and                   // 3. RSI not overbought
                high_volume and                // 4. Good volume
                strategy.position_size == 0    // 5. No open position

// SELL CONDITIONS (ALL must be true)
sell_condition = downtrend and                 // 1. Downtrend confirmed
                 ta.crossunder(ema9, ema21) and // 2. EMA crossunder
                 rsi > 40 and                  // 3. RSI not oversold
                 high_volume and               // 4. Good volume
                 strategy.position_size == 0   // 5. No open position

// ============================================================================
// POSITION MANAGEMENT
// ============================================================================

// Calculate stop loss and take profit levels
if strategy.position_size > 0  // Long position
    stop_price = strategy.position_avg_price * (1 - stop_loss_pct / 100)
    profit_price = strategy.position_avg_price * (1 + take_profit_pct / 100)
    strategy.exit("Exit Long", "Long", stop=stop_price, limit=profit_price)

if strategy.position_size < 0  // Short position
    stop_price = strategy.position_avg_price * (1 + stop_loss_pct / 100)
    profit_price = strategy.position_avg_price * (1 - take_profit_pct / 100)
    strategy.exit("Exit Short", "Short", stop=stop_price, limit=profit_price)

// ============================================================================
// EXECUTE TRADES
// ============================================================================

// LONG ENTRY
if buy_condition
    strategy.entry("Long", strategy.long)
    // Send webhook alert to bot
    alert('{"action": "BUY", "symbol": "' + syminfo.ticker + '", "price": "' + str.tostring(close) + '", "strategy": "EMA_RSI", "timeframe": "' + timeframe.period + '"}', alert.freq_once_per_bar)

// SHORT ENTRY (if you want to short)
if sell_condition
    strategy.entry("Short", strategy.short)
    // Send webhook alert to bot
    alert('{"action": "SELL", "symbol": "' + syminfo.ticker + '", "price": "' + str.tostring(close) + '", "strategy": "EMA_RSI", "timeframe": "' + timeframe.period + '"}', alert.freq_once_per_bar)

// ============================================================================
// VISUAL INDICATORS
// ============================================================================

// Plot EMAs
plot(ema9, "EMA 9", color=color.blue, linewidth=2)
plot(ema21, "EMA 21", color=color.orange, linewidth=2)
plot(ema200, "EMA 200", color=color.red, linewidth=3)

// Background color for trend
bgcolor(uptrend ? color.new(color.green, 95) : downtrend ? color.new(color.red, 95) : color.new(color.gray, 98))

// Plot buy/sell signals
plotshape(buy_condition, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.normal)
plotshape(sell_condition, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.normal)

// ============================================================================
// PERFORMANCE TABLE (MONITOR RESULTS)
// ============================================================================

if barstate.islast
    var table performance_table = table.new(position.top_right, 2, 6, bgcolor=color.white, border_width=1)
    
    // Calculate performance metrics
    total_trades = strategy.closedtrades
    win_rate = total_trades > 0 ? (strategy.wintrades / total_trades) * 100 : 0
    profit_factor = strategy.grossprofit / math.max(strategy.grossloss, 1)
    
    table.cell(performance_table, 0, 0, "Metric", text_color=color.black, bgcolor=color.gray)
    table.cell(performance_table, 1, 0, "Value", text_color=color.black, bgcolor=color.gray)
    
    table.cell(performance_table, 0, 1, "Total Trades", text_color=color.black)
    table.cell(performance_table, 1, 1, str.tostring(total_trades), text_color=color.black)
    
    table.cell(performance_table, 0, 2, "Win Rate %", text_color=color.black)
    table.cell(performance_table, 1, 2, str.tostring(win_rate, "#.##"), text_color=color.black)
    
    table.cell(performance_table, 0, 3, "Profit Factor", text_color=color.black)
    table.cell(performance_table, 1, 3, str.tostring(profit_factor, "#.##"), text_color=color.black)
    
    table.cell(performance_table, 0, 4, "Net Profit %", text_color=color.black)
    table.cell(performance_table, 1, 4, str.tostring(strategy.netprofit / strategy.initial_capital * 100, "#.##"), text_color=color.black)
    
    table.cell(performance_table, 0, 5, "Max DD %", text_color=color.black)
    table.cell(performance_table, 1, 5, str.tostring(strategy.max_drawdown / strategy.initial_capital * 100, "#.##"), text_color=color.red)

// ============================================================================
// STRATEGY NOTES
// ============================================================================

// PROFITABLE RULES:
// 1. Only trade WITH the main trend (EMA 200)
// 2. Wait for EMA crossover confirmation
// 3. Use RSI to avoid extreme conditions
// 4. Require good volume
// 5. Always use stop loss (2%)
// 6. Take profit at 4% (2:1 risk/reward)
// 7. One position at a time
// 8. Use 15m or 1h timeframe (avoid noise)

// BACKTEST TARGETS:
// - Win rate: 45-55%
// - Profit factor: > 1.3
// - Max drawdown: < 15%
// - Sharpe ratio: > 1.0